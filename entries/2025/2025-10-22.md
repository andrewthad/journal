# Second-Class Lambdas

In a toy language, I was trying to write a function to encode an HTML syntax
tree, and I realized that I needed to be able to map over an array. I've not
been able to bother with any of the low-level stuff (which would require
a substructural type system) that would be used to implement a map function,
so I need to just lower `map` directly to C code. This isn't difficult, but
it means that I need to be able to pass a lambda to a function. The lambda
could be passed straight in, not using ANF, and that would make lowering
easier since it would make it simple to inline the implementation of `map`.
In a way, this is a crummy version of staging, where only built-in functions
are allowed to be lowered this way.

This is pushing me further in the direction of abandoning ANF. I do not want
to go all the way in the direction of having a single expression type. The
reasons are:

* When parsing the source language, it is helpful to know that a multi-line
  expression cannot appear as an argument to a function.
* When lowering to C, there are some amount of ANF-like properties that are
  essential. It's not possible to feed an arbitrary block of C code into
  a function as an argument.

Something that C does support, that pure ANF does not, is expressions
like `foo(bar(x), baz(y))`, and it's often much more clear to write code
that looks like this rather than inventing binders for the arguments.

Another good example of something that I would like to be able to do in
the source language is passing an array literal (heap allocated) to a function.
This doesn't lower to C super cleanly (you might need a binder for it), but
it would clean up some of my examples.

Binding lambdas should not be difficult. As long as lambdas are second class,
a lambda environment can be allocated on the stack. I have been reluctant to
support this but I think it will be a critical feature.

# Region Woes

All the region annotations, especially in the presence of stack-allocated
types, are a bit of a pain to deal with. I still need to figure out how
to deal with this.

# Upcasting Array to Builder

I've ended up with types for array and builder that are the same size. It
should be possible to make array a subtype of builder. It's not critical
to do this, but it would reduce the syntactic burden of constructing builders.
